---
import AuthLayout from "~/layouts/AuthLayout.astro";
import LinksIndex from "~/components/LinksIndex";
import { searchUserLinks } from "~/lib/models/link.server";
import { searchUserTags } from "~/lib/models/tag.server";
import { searchParamsToFormValues } from "~/lib/util/useSearchFormState";

const userId = Astro.locals.userId!;
const url = new URL(Astro.request.url);
const { tags } = searchParamsToFormValues(url.searchParams);

const [commonTags, links] = await Promise.all([
  searchUserTags({ userId, tags }),
  searchUserLinks({ userId, tags }),
]);

const commonTagNames = commonTags.map((tag) => tag.name);
---

<AuthLayout title="Your Links">
  <LinksIndex
    initialLinks={links}
    initialCommonTags={commonTagNames}
    userId={userId}
    client:load
  />
</AuthLayout>
