---
import AuthLayout from "~/layouts/AuthLayout.astro";
import UserSidebar from "~/components/UserSidebar.astro";
import TagComponent from "~/components/Tag";
import { getLinksForTag } from "~/lib/models/link.server";
import { getUserTag, renameUserTag } from "~/lib/models/tag.server";
import { getUserById } from "~/lib/models/user.server";
import { decodeStringArray } from "~/lib/util/stringArray";

const userId = Astro.locals.userId!;
const user = await getUserById(userId);
if (!user) return new Response("Not Found", { status: 404 });

const tagParam = Astro.params.tag;
if (!tagParam) return new Response("Not Found", { status: 404 });

const tag = await getUserTag({ userId, name: tagParam });
if (!tag) return new Response("Not Found", { status: 404 });

const links = await getLinksForTag({ userId, name: tagParam });
const numLinks = links.length;
const numLinksOnly = links.filter((link) => link.tags.length === 1).length;

interface FormErrors {
  name?: string;
  delete?: string;
}

let errors: FormErrors = {};

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();

  if (formData.get("_method") === "delete") {
    const currentLinks = await getLinksForTag({ userId, name: tagParam });
    if (currentLinks.length > 0) {
      errors.delete = `${currentLinks.length} links still using this tag`;
    } else {
      return Astro.redirect("/links");
    }
  } else if (formData.get("_action") === "rename") {
    const renameValue = formData.get("name") ?? "";
    if (typeof renameValue !== "string") {
      errors.name = "Name not valid";
    } else {
      const decodedTags = decodeStringArray(renameValue);
      if (decodedTags.length !== 1) {
        errors.name = "Name not valid";
      } else {
        const newName = decodedTags[0];
        if (newName === tagParam) {
          errors.name = "Name not changed";
        } else {
          const existingTag = await getUserTag({ userId, name: newName });
          if (existingTag) {
            errors.name = "Tag already exists with that name";
          } else {
            await renameUserTag({ userId, tagId: tag.id, newName });
            return Astro.redirect(`/user/tags/${encodeURIComponent(newName)}`);
          }
        }
      }
    }
  }
}
---

<AuthLayout title={`Edit Tag: ${tag.name}`}>
  <div class="flex flex-col md:flex-row md:justify-center">
    <UserSidebar isAdmin={user.isAdmin} />
    <main class="flex-1 p-6 md:max-w-xl lg:max-w-2xl">
      <div class="flex flex-col gap-4">
        <h2 class="text-2xl font-normal lowercase">Edit {tag.name}</h2>
        <div class="flex-1 md:max-w-xl lg:max-w-2xl">
          <p>
            There are {numLinks} links with the tag{" "}
            <TagComponent component="span" name={tag.name} state="inactive" />.
            Making changes on this page will affect those links.
          </p>
          <form method="post">
            <h2 class="mb-2 text-xl font-normal lowercase">Rename</h2>
            <input type="hidden" name="_action" value="rename" />
            <div class="my-2">
              <label
                for="name"
                class="block text-sm font-medium lowercase text-label"
              >
                Name
              </label>
              <input
                id="name"
                required
                autocomplete="off"
                autofocus
                name="name"
                type="text"
                aria-invalid={errors.name ? "true" : undefined}
                aria-describedby="name-error"
                class="w-full border border-input-border bg-input px-2 py-1 text-lg"
                value={tag.name}
              />
              {
                errors.name && (
                  <div class="pt-1 text-red-700" id="name-error">
                    {errors.name}
                  </div>
                )
              }
            </div>
            <button
              type="submit"
              class="w-full border border-button-border px-4 py-2 lowercase text-text hover:bg-button-hover active:bg-button-active"
            >
              Rename <TagComponent
                component="span"
                name={tag.name}
                state="inactive"
              />
            </button>
          </form>
          <div class="mt-4 border border-card-error-border bg-card-error p-2">
            <form method="post">
              <h2 class="mb-2 text-xl font-normal lowercase text-text-error">
                Danger zone
              </h2>
              <input type="hidden" name="_method" value="delete" />
              <button
                type="submit"
                class="md:1/3 mt-2 w-full border border-button-error-border px-4 py-2 lowercase text-text-error enabled:hover:bg-button-error-hover enabled:active:bg-button-error-active sm:w-1/2"
                disabled={numLinksOnly > 0}
              >
                Delete <TagComponent
                  component="span"
                  name={tag.name}
                  state="negative"
                />
              </button>
              {
                numLinksOnly > 0 ? (
                  <p class="text-sm font-normal lowercase text-text-error">
                    There are {numLinksOnly} links that only use this tag. You
                    must add other tags to these links before you can delete
                    this tag.
                  </p>
                ) : (
                  <p class="text-sm font-normal lowercase text-text-error">
                    This action can not be undone
                  </p>
                )
              }
              {
                errors.delete && (
                  <div class="pt-1 text-text-error">{errors.delete}</div>
                )
              }
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</AuthLayout>
