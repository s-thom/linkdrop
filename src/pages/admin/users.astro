---
import AuthLayout from "~/layouts/AuthLayout.astro";
import AdminSidebar from "~/components/AdminSidebar.astro";
import { getAllUsersSummary } from "~/lib/models/admin.server";
import { getUserById } from "~/lib/models/user.server";

const userId = Astro.locals.userId!;
const user = await getUserById(userId);

if (!user || !user.isAdmin) {
  return new Response("Not Found", { status: 404 });
}

const allUsers = await getAllUsersSummary();
const users = allUsers.map((u) => ({
  id: u.id,
  email: u.email,
  createdAt: u.createdAt,
  isAdmin: u.isAdmin,
  mostRecentLinkCreatedAt: u.links[0]?.createdAt ?? undefined,
  numLinks: u._count.links,
  numTags: u._count.tags,
  hasTotp: u.totp?.active ?? false,
}));
---

<AuthLayout title="Admin - Users">
  <div class="flex flex-col md:flex-row md:justify-center">
    <AdminSidebar />
    <main class="flex-1 p-6 md:max-w-xl lg:max-w-2xl">
      <table class="border-spacing-1 border border-card-border bg-card">
        <thead>
          <tr>
            <th class="border border-card-border p-1">Email</th>
            <th class="border border-card-border p-1">Created (UTC)</th>
            <th class="border border-card-border p-1">Number of links</th>
            <th class="border border-card-border p-1">Number of tags</th>
            <th class="border border-card-border p-1">Most recent link</th>
            <th class="border border-card-border p-1">TOTP Setup</th>
            <th class="border border-card-border p-1">Is Admin</th>
          </tr>
        </thead>
        <tbody>
          {
            users.map((u) => (
              <tr class="hover:bg-button-active">
                <td class="border border-card-border p-1">
                  <a
                    href={`/admin/users/${u.id}`}
                    class="text-nav-link underline decoration-1 hover:text-nav-link hover:no-underline active:text-nav-link-active"
                  >
                    {u.email}
                  </a>
                </td>
                <td class="border border-card-border p-1">
                  <time
                    datetime={u.createdAt.toISOString()}
                    title={u.createdAt.toISOString()}
                  >
                    {u.createdAt.toLocaleDateString("en-NZ")}
                  </time>
                </td>
                <td class="border border-card-border p-1">{u.numLinks}</td>
                <td class="border border-card-border p-1">{u.numTags}</td>
                <td class="border border-card-border p-1">
                  {u.mostRecentLinkCreatedAt ? (
                    <time
                      datetime={u.mostRecentLinkCreatedAt.toISOString()}
                      title={u.mostRecentLinkCreatedAt.toISOString()}
                    >
                      {u.mostRecentLinkCreatedAt.toLocaleDateString("en-NZ")}
                    </time>
                  ) : (
                    ""
                  )}
                </td>
                <td class="border border-card-border p-1">
                  <input
                    type="checkbox"
                    name={`${u.id}-totp`}
                    readonly
                    checked={u.hasTotp}
                  />
                </td>
                <td class="border border-card-border p-1">
                  <input
                    type="checkbox"
                    name={`${u.id}-admin`}
                    readonly
                    checked={u.isAdmin}
                  />
                </td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </main>
  </div>
</AuthLayout>
