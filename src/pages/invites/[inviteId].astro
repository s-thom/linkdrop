---
import { createUserSession, getUser } from "~/lib/session";
import { getUserInvite } from "~/lib/models/invites.server";
import { createUser, getUserByEmail } from "~/lib/models/user.server";
import { validateEmail } from "~/utils";
import PublicLayout from "~/layouts/PublicLayout.astro";
import { LinkDropText } from "~/components/LinkDropText";
import {
  ensureCsrfToken,
  csrfCookieHeader,
  validateCsrf,
} from "~/lib/util/csrf.server";

const { inviteId } = Astro.params;

if (!inviteId) {
  return new Response("Not Found", { status: 404 });
}

const invite = await getUserInvite({ id: inviteId });
if (!invite || invite.inviteeUserId) {
  return new Response("Not Found", { status: 404 });
}

const currentUser = await getUser(Astro.request);

interface ActionErrors {
  email?: string;
  password?: string;
  submit?: string;
}

let errors: ActionErrors = {};

const { token: csrfToken, isNew: csrfIsNew } = ensureCsrfToken(Astro.request);
if (csrfIsNew) {
  Astro.response.headers.append("Set-Cookie", csrfCookieHeader(csrfToken));
}

if (Astro.request.method === "POST") {
  if (currentUser) {
    errors.submit =
      "You already have an account! Send this link to someone else so they can sign up.";
  } else {
    const formData = await Astro.request.formData();
    if (!validateCsrf(Astro.request, formData)) {
      return new Response("Forbidden", { status: 403 });
    }

    const email = formData.get("email");
    const password = formData.get("password");

    if (!validateEmail(email)) {
      errors.email = "Email is invalid";
    } else if (typeof password !== "string") {
      errors.password = "Password is required";
    } else if (password.length < 8) {
      errors.password = "Password is too short";
    } else if (password.length > 128) {
      errors.password = "Password must be 128 characters or fewer";
    } else {
      const existingUser = await getUserByEmail(email);
      if (existingUser) {
        errors.email = "A user already exists with this email";
      } else {
        const newUser = await createUser(email, password, inviteId);
        return createUserSession({
          userId: newUser.id,
          sessionVersion: newUser.sessionVersion,
          remember: false,
          redirectTo: "/links",
        });
      }
    }
  }
}
---

<PublicLayout title="Sign Up">
  <div class="mx-auto w-full max-w-md px-8">
    {
      currentUser === null ? (
        <p class="my-2 lowercase">
          You've been invited to try <LinkDropText />, where you can save and
          search for the links you find around the internet.
        </p>
      ) : (
        <p class="my-2 text-text-error lowercase">
          You already have an account! Send this link to someone else so they
          can sign up.
        </p>
      )
    }
    <form method="post" class="space-y-6" novalidate>
      <div>
        <label
          for="email"
          class="block text-sm font-medium lowercase text-label"
        >
          Email address
        </label>
        <div class="mt-1">
          <input
            id="email"
            required
            autofocus
            name="email"
            type="email"
            autocomplete="email"
            aria-invalid={errors.email ? "true" : undefined}
            aria-describedby="email-error"
            class="w-full border border-input-border bg-input px-2 py-1 text-lg"
            readonly={currentUser !== null}
          />
          {
            errors.email && (
              <div class="pt-1 text-text-error" id="email-error">
                {errors.email}
              </div>
            )
          }
        </div>
      </div>
      <div>
        <label
          for="password"
          class="block text-sm font-medium lowercase text-label"
        >
          Password
        </label>
        <div class="mt-1">
          <input
            id="password"
            name="password"
            type="password"
            autocomplete="new-password"
            aria-invalid={errors.password ? "true" : undefined}
            aria-describedby="password-error"
            class="w-full border border-input-border bg-input px-2 py-1 text-lg"
            readonly={currentUser !== null}
          />
          {
            errors.password && (
              <div class="pt-1 text-text-error" id="password-error">
                {errors.password}
              </div>
            )
          }
        </div>
      </div>
      <input type="hidden" name="__csrf" value={csrfToken} />
      <button
        type="submit"
        class="w-full border border-button-border bg-button px-4 py-2 lowercase text-text enabled:hover:bg-button-hover enabled:active:bg-button-active"
        disabled={currentUser !== null}
      >
        Sign up
      </button>
      {
        errors.submit && (
          <div class="pt-1 text-text-error" id="submit-error">
            {errors.submit}
          </div>
        )
      }
    </form>
  </div>
</PublicLayout>
